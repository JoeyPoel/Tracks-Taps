generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum SessionStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  name         String
  level        Int      @default(1)
  xp           Int      @default(0)
  tokens       Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  createdTours Tour[]   @relation("TourAuthor")
  reviews      Review[]
  teams        Team[]

  activeTours ActiveTour[]
}

model Tour {
  id              Int        @id @default(autoincrement())
  title           String
  location        String
  description     String
  imageUrl        String
  distance        Float // Stored as Float for calculations
  duration        Int // Stored in minutes
  points          Int
  modes           String[] // PostgreSQL array for modes
  difficulty      Difficulty
  challengesCount Int        @default(0) // Cache field
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  startLat        Float? // Optimization for map queries
  startLng        Float? // Optimization for map queries

  // Relations
  authorId    Int
  author      User         @relation("TourAuthor", fields: [authorId], references: [id])
  stops       Stop[]
  challenges  Challenge[] // Global challenges for the tour
  reviews     Review[]
  activeTours ActiveTour[]
}

model Stop {
  id           Int      @id @default(autoincrement())
  tourId       Int
  tour         Tour     @relation(fields: [tourId], references: [id])
  number       Int
  name         String
  description  String
  order        Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  longitude    Float
  latitude     Float
  pubgolfPar   Int?
  pubgolfDrink String?

  // Relations
  challenges   Challenge[] // Stop-specific challenges
  pubGolfStops PubGolfStop[]
}

enum ChallengeType {
  LOCATION
  TRIVIA
}

model Challenge {
  id          Int           @id @default(autoincrement())
  title       String
  description String
  type        ChallengeType
  points      Int
  content     String? // Question for trivia, or extra info
  answer      String? // For trivia
  options     String[] // For trivia
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Polymorphic Relations (Nullable FKs)
  tourId Int?
  tour   Tour? @relation(fields: [tourId], references: [id])
  stopId Int?
  stop   Stop? @relation(fields: [stopId], references: [id])

  // Relations
  activeChallenges ActiveChallenge[]
}

model ActiveTour {
  id           Int           @id // Manually assigned 9-digit ID
  tourId       Int
  tour         Tour          @relation(fields: [tourId], references: [id])
  status       SessionStatus @default(WAITING)
  winnerTeamId Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  teams  Team[]
  user   User?  @relation(fields: [userId], references: [id])
  userId Int?
}

model Team {
  id           Int        @id @default(autoincrement())
  activeTourId Int
  activeTour   ActiveTour @relation(fields: [activeTourId], references: [id], onDelete: Cascade)
  userId       Int
  user         User       @relation(fields: [userId], references: [id])

  name  String?
  color String?
  emoji String?

  currentStop Int       @default(1)
  streak      Int       @default(0)
  score       Int       @default(0)
  finishedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  activeChallenges ActiveChallenge[]
  pubGolfStops     PubGolfStop[]
}

model ActiveChallenge {
  id          Int       @id @default(autoincrement())
  teamId      Int
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  challengeId Int
  challenge   Challenge @relation(fields: [challengeId], references: [id])
  completed   Boolean   @default(false)
  completedAt DateTime?
  failed      Boolean   @default(false)

  @@unique([teamId, challengeId])
}

model PubGolfStop {
  id        Int      @id @default(autoincrement())
  teamId    Int
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  stopId    Int
  stop      Stop     @relation(fields: [stopId], references: [id])
  sips      Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id        Int      @id @default(autoincrement())
  content   String
  rating    Int
  photos    String[] // PostgreSQL array for photo URLs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tourId   Int
  tour     Tour @relation(fields: [tourId], references: [id])
  authorId Int
  author   User @relation(fields: [authorId], references: [id])
}
