generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  engineType    = "library"
}

datasource db {
  provider = "postgresql"
}

enum StopType {
  Food_Dining
  Coffee_Drink
  Nightlife
  Museum_Art
  Monument_Landmark
  Religious
  Nature_Park
  Shopping
  Transit_Stop
  Viewpoint
  Info_Point
  Facilities
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum TourType {
  QUICK_TRIP
  DAY_TRIP
  MULTI_DAY
  EXPEDITION
}

enum TourStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  REJECTED
}

enum SessionStatus {
  WAITING
  PRE_TOUR_LOBBY
  IN_PROGRESS
  POST_TOUR_LOBBY
  COMPLETED
  ABANDONED
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  name         String
  avatarUrl    String?
  level        Int      @default(1)
  xp           Int      @default(0)
  tokens       Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  createdTours Tour[]   @relation("TourAuthor")
  reviews      Review[]
  teams        Team[]

  activeTours ActiveTour[]
  playedTours UserPlayedTour[]

  feedbacks Feedback[]

  // Friendships
  friendshipsInitiated Friendship[] @relation("FriendshipInitiated")
  friendshipsReceived  Friendship[] @relation("FriendshipReceived")

  // Game Invites
  sentInvites     GameInvite[] @relation("SentInvites")
  receivedInvites GameInvite[] @relation("ReceivedInvites")

  // Achievements
  achievements UserAchievement[]
  tourLists    TourList[]

  @@index([email])
}

model Friendship {
  id        Int      @id @default(autoincrement())
  status    String   @default("PENDING") // PENDING, ACCEPTED, DECLINED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  requesterId Int
  requester   User @relation("FriendshipInitiated", fields: [requesterId], references: [id])
  addresseeId Int
  addressee   User @relation("FriendshipReceived", fields: [addresseeId], references: [id])

  @@unique([requesterId, addresseeId])
  @@index([requesterId])
  @@index([addresseeId])
  @@index([status])
}

model GameInvite {
  id Int @id @default(autoincrement())

  // Link to ActiveTour (Session)
  activeTourId Int
  activeTour   ActiveTour @relation(fields: [activeTourId], references: [id], onDelete: Cascade)

  inviterId Int
  inviter   User @relation("SentInvites", fields: [inviterId], references: [id])

  inviteeId Int
  invitee   User @relation("ReceivedInvites", fields: [inviteeId], references: [id])

  status String @default("PENDING") // PENDING, ACCEPTED, DECLINED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tour      Tour?    @relation(fields: [tourId], references: [id])
  tourId    Int?

  @@index([inviteeId])
  @@index([inviterId])
  @@index([activeTourId])
  @@index([status])
}

model Tour {
  id          Int        @id @default(autoincrement())
  title       String
  location    String
  description String
  imageUrl    String
  distance    Float // Stored as Float for calculations
  duration    Int // Stored in minutes
  points      Int
  modes       String[] // PostgreSQL array for modes
  difficulty  Difficulty
  status      TourStatus @default(PENDING_REVIEW) // Review Status
  type        TourType   @default(QUICK_TRIP) // New field: Tour Duration Type
  genre       String     @default("Adventure") // New field: Genre
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  startLat    Float? // Optimization for map queries
  startLng    Float? // Optimization for map queries

  // Relations
  authorId    Int
  author      User             @relation("TourAuthor", fields: [authorId], references: [id])
  stops       Stop[]
  challenges  Challenge[] // Global challenges for the tour
  reviews     Review[]
  activeTours ActiveTour[]
  playedTours UserPlayedTour[]
  feedbacks   Feedback[]
  gameInvites GameInvite[]
  lists       TourList[]       @relation("TourListTours")

  @@index([authorId])
}

model Stop {
  id          Int    @id @default(autoincrement())
  tourId      Int
  tour        Tour   @relation(fields: [tourId], references: [id], onDelete: Cascade)
  number      Int
  name        String
  description String

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  longitude           Float
  latitude            Float
  type                StopType @default(Viewpoint)
  pubgolfPar          Int?
  pubgolfDrink        String?
  imageUrl            String?
  detailedDescription String?

  // Relations
  challenges   Challenge[] // Stop-specific challenges
  pubGolfStops PubGolfStop[]

  @@index([tourId])
}

enum ChallengeType {
  LOCATION
  TRIVIA
  PICTURE
  TRUE_FALSE
  DARE
  RIDDLE
}

model Challenge {
  id        Int           @id @default(autoincrement())
  title     String
  type      ChallengeType
  points    Int
  content   String? // Question for trivia, or extra info
  hint      String?
  answer    String? // For trivia
  options   String[] // For trivia
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Polymorphic Relations (Nullable FKs)
  tourId Int?
  tour   Tour? @relation(fields: [tourId], references: [id], onDelete: Cascade)
  stopId Int?
  stop   Stop? @relation(fields: [stopId], references: [id], onDelete: Cascade)

  // Relations
  activeChallenges ActiveChallenge[]

  @@index([tourId])
  @@index([stopId])
}

model ActiveTour {
  id           Int           @id // Manually assigned 9-digit ID
  tourId       Int
  tour         Tour          @relation(fields: [tourId], references: [id], onDelete: Cascade)
  status       SessionStatus @default(WAITING)
  winnerTeamId Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  teams       Team[]
  user        User?        @relation(fields: [userId], references: [id])
  userId      Int?
  gameInvites GameInvite[]

  @@index([tourId])
  @@index([userId])
  @@index([status])
}

model Team {
  id           Int        @id @default(autoincrement())
  activeTourId Int
  activeTour   ActiveTour @relation(fields: [activeTourId], references: [id], onDelete: Cascade)
  userId       Int
  user         User       @relation(fields: [userId], references: [id])

  name  String?
  color String?
  emoji String?

  currentStop Int       @default(1)
  streak      Int       @default(0)
  score       Int       @default(0)
  finishedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  activeChallenges ActiveChallenge[]
  pubGolfStops     PubGolfStop[]

  @@index([activeTourId])
  @@index([userId])
}

model ActiveChallenge {
  id          Int       @id @default(autoincrement())
  teamId      Int
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  challengeId Int
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  completed   Boolean   @default(false)
  completedAt DateTime?
  failed      Boolean   @default(false)

  @@unique([teamId, challengeId])
  @@index([teamId])
  @@index([challengeId])
}

model PubGolfStop {
  id        Int      @id @default(autoincrement())
  teamId    Int
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  stopId    Int
  stop      Stop     @relation(fields: [stopId], references: [id], onDelete: Cascade)
  sips      Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([stopId])
}

model Review {
  id        Int      @id @default(autoincrement())
  content   String
  rating    Int
  photos    String[] // PostgreSQL array for photo URLs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tourId   Int
  tour     Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)
  authorId Int
  author   User @relation(fields: [authorId], references: [id])

  @@index([tourId])
  @@index([authorId])
}

model UserPlayedTour {
  id         Int           @id @default(autoincrement())
  userId     Int
  user       User          @relation(fields: [userId], references: [id])
  tourId     Int
  tour       Tour          @relation(fields: [tourId], references: [id])
  status     SessionStatus
  score      Int           @default(0)
  startedAt  DateTime
  finishedAt DateTime      @default(now())
  teamName   String?
  createdAt  DateTime      @default(now())

  @@index([userId])
  @@index([tourId])
}

model Achievement {
  id          Int     @id @default(autoincrement())
  title       String
  description String
  icon        String // 'trophy', 'map', 'flame', etc.
  emoji       String? @default("üèÜ") // New field for toast display
  color       String  @default("#FFC107") // hex color
  criteria    String // 'TOUR_COMPLETION', 'FRIEND_ADD', 'STREAK', etc.
  target      Int     @default(1)
  xpReward    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userAchievements UserAchievement[]
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        Int
  user          User        @relation(fields: [userId], references: [id])
  achievementId Int
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  unlockedAt    DateTime    @default(now())

  @@unique([userId, achievementId])
  @@index([userId])
}

model Feedback {
  id        Int      @id @default(autoincrement())
  tourId    Int?
  tour      Tour?    @relation(fields: [tourId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  rating    Int
  feedback  String?
  source    String // e.g. "TOUR_COMPLETION", "PROFILE"
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([tourId])
  @@index([userId])
}

model TourList {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tours     Tour[]   @relation("TourListTours")
  tourOrder Int[]    @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}
